{
  "created_at": "2026-02-10T23:30:00Z",
  "story_id": "01",
  "story_title": "subscription-lookback-window",

  "questions": [
    {
      "id": "VQ-01-001",
      "category": "TEST",
      "question": "Do property-based tests verify NIP-17 timestamp randomization coverage?",
      "actionable_check": "Run subscription-lookback.test.ts and verify P006 and P007 properties pass with 1000+ test cases",
      "evidence_required": [
        "test file path",
        "property names covering randomization",
        "test execution results"
      ],
      "pass_criteria": "Properties P006 (3-day window coverage) and P007 (no missed events) pass with 1000 generated cases",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-002",
      "category": "SPEC",
      "question": "Is the 3-day lookback window correctly applied to kind 1059 events?",
      "actionable_check": "Read src/main/nostling/service.ts lines 1423-1438 and verify conditional logic: kind === 1059 uses NIP17_TIMESTAMP_WINDOW",
      "evidence_required": [
        "code snippet showing conditional",
        "constant value (259200 seconds = 3 days)",
        "kind comparison logic"
      ],
      "pass_criteria": "Code shows: lookbackWindow = kind === 1059 ? NIP17_TIMESTAMP_WINDOW : FIRST_STREAM_LOOKBACK",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-003",
      "category": "SPEC",
      "question": "Is the 24-hour lookback preserved for kind 4 and other event types?",
      "actionable_check": "Verify P002 (kind 4) and P008 (backward compatibility) tests pass, confirming FIRST_STREAM_LOOKBACK (86400 seconds)",
      "evidence_required": [
        "test results for P002 and P008",
        "constant value verification",
        "non-1059 kinds behavior"
      ],
      "pass_criteria": "Tests confirm kind 4 and all non-1059 kinds use 24-hour (86400 second) window",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-004",
      "category": "ARCHITECTURE",
      "question": "Is the lookback window selection localized to startSubscription method?",
      "actionable_check": "Search for NIP17_TIMESTAMP_WINDOW usage in codebase - should only appear in service.ts constant declaration and startSubscription",
      "evidence_required": [
        "grep/search results",
        "usage locations",
        "method boundaries"
      ],
      "pass_criteria": "NIP17_TIMESTAMP_WINDOW used only in: constant declaration and startSubscription filtersWithSince mapping",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-005",
      "category": "QUALITY",
      "question": "Are the constants clearly documented with rationale?",
      "actionable_check": "Read constant declarations around line 68-71 in service.ts for inline comments explaining the 3-day calculation",
      "evidence_required": [
        "constant declaration with comment",
        "explanation of 2d randomization + 1d buffer"
      ],
      "pass_criteria": "Comment explains: '3 days for NIP-17 gift wraps (2d randomization + 1d buffer)'",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-006",
      "category": "TEST",
      "question": "Do tests verify the mathematical relationship between windows?",
      "actionable_check": "Review P001 assertion: NIP17_TIMESTAMP_WINDOW > FIRST_STREAM_LOOKBACK",
      "evidence_required": [
        "test code showing comparison",
        "assertion that 3-day > 24-hour"
      ],
      "pass_criteria": "Test P001 explicitly asserts actualLookback > FIRST_STREAM_LOOKBACK",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-007",
      "category": "SPEC",
      "question": "Does the implementation handle both first subscription and resumption scenarios?",
      "actionable_check": "Read startSubscription lines 1429-1435 - verify lookbackWindow applies when lastTimestamp is undefined (first subscription)",
      "evidence_required": [
        "conditional logic for lastTimestamp",
        "application of lookbackWindow in else branch"
      ],
      "pass_criteria": "Code shows: lastTimestamp ? (lastTimestamp - CLOCK_SKEW_BUFFER) : (now - lookbackWindow)",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-008",
      "category": "QUALITY",
      "question": "Is the clock skew buffer applied consistently across all event kinds?",
      "actionable_check": "Run P004 test - verify CLOCK_SKEW_BUFFER (60s) is subtracted from lastTimestamp regardless of kind",
      "evidence_required": [
        "P004 test results",
        "verification for both kind 4 and 1059"
      ],
      "pass_criteria": "P004 passes for both kinds with 100 generated cases, confirming uniform buffer application",
      "added_in_round": 1
    }
  ],

  "mandatory_questions": [
    {
      "id": "VQ-01-DEAD",
      "category": "QUALITY",
      "question": "Is there any dead code introduced by this story?",
      "actionable_check": "Search for unused functions, classes, imports in files modified by this story (service.ts, subscription-lookback.test.ts)",
      "evidence_required": [
        "file paths",
        "unused symbol names if any"
      ],
      "pass_criteria": "No unused code in story scope - all constants and logic are actively used",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-DUP",
      "category": "QUALITY",
      "question": "Are there any duplicate implementations?",
      "actionable_check": "Check for similar timestamp calculation logic in other files (polling.ts, service-integration.test.ts)",
      "evidence_required": [
        "file paths checked",
        "any duplicated logic found"
      ],
      "pass_criteria": "No duplicate lookback window logic - implementation is centralized in startSubscription",
      "added_in_round": 1
    },
    {
      "id": "VQ-01-INT",
      "category": "TEST",
      "question": "Do integration tests validate the story's workflow?",
      "actionable_check": "Verify subscription-lookback.test.ts contains end-to-end properties (P007) that test complete timestamp randomization scenarios",
      "evidence_required": [
        "test file",
        "P007 property description",
        "1000 test cases executed"
      ],
      "pass_criteria": "P007 'Events with randomized timestamps within 2 days are not missed' covers the complete workflow with 1000 cases",
      "added_in_round": 1
    }
  ]
}
