##
## Strfry Relay Configuration for Nostling
##
## This configuration is optimized for local development and e2e testing.
## For production deployments, review and adjust settings based on your infrastructure.
##

# Directory that contains the strfry LMDB database (restart required)
# In Docker: This will be mounted to a volume for persistence
db = "./strfry-db/"

dbParams {
    # Maximum number of threads/processes that can simultaneously have LMDB transactions open (restart required)
    # Dev/E2E: Lower value suitable for single-user testing
    maxreaders = 256

    # Size of mmap() to use when loading LMDB (default is 10TB, does *not* correspond to disk-space used) (restart required)
    # Dev/E2E: 10GB should be sufficient for testing
    mapsize = 10737418240

    # Disables read-ahead when accessing the LMDB mapping. Reduces IO activity when DB size is larger than RAM. (restart required)
    # Dev/E2E: Keep false for better performance on small datasets
    noReadAhead = false
}

events {
    # Maximum size of normalised JSON, in bytes
    # Dev/E2E: Standard max event size
    maxEventSize = 65536

    # Events newer than this will be rejected (in seconds)
    # Dev/E2E: 15 minutes tolerance for clock skew
    rejectEventsNewerThanSeconds = 900

    # Events older than this will be rejected (in seconds)
    # Dev/E2E: ~3 years, sufficient for historical data
    rejectEventsOlderThanSeconds = 94608000

    # Ephemeral events older than this will be rejected (in seconds)
    ephemeralEventsOlderThanSeconds = 60

    # Ephemeral events will be deleted from the DB when older than this (in seconds)
    ephemeralEventsLifetimeSeconds = 300

    # Maximum number of tags allowed per event
    maxNumTags = 2000

    # Maximum size for tag values, in bytes
    maxTagValSize = 1024
}

relay {
    # Interface to listen on. Use 0.0.0.0 to listen on all interfaces (restart required)
    # Docker: Bind to all interfaces so relay is reachable from host
    bind = "0.0.0.0"

    # Port to open for the nostr websocket protocol (restart required)
    # Standard port: 8080 (matches existing relay configuration)
    port = 8080

    # Set OS-limit on maximum number of open files/sockets (if 0, don't attempt to set) (restart required)
    # Dev/E2E: Lower value sufficient for testing
    nofiles = 10000

    # HTTP header that contains the client's real IP, before reverse proxying (MUST be all lower-case)
    # Docker: Empty for direct connections, set to "x-real-ip" if behind reverse proxy
    realIpHeader = ""

    info {
        # NIP-11: Name of this server. Short/descriptive (< 30 characters)
        name = "Nostling Dev Relay"

        # NIP-11: Detailed information about relay, free-form
        description = "Strfry relay for Nostling local development and E2E testing."

        # NIP-11: Administrative nostr pubkey, for contact purposes (32-byte hex, not npub)
        # Dev/E2E: Empty for local testing
        pubkey = ""

        # NIP-11: Alternative administrative contact (email, website, etc)
        contact = ""

        # NIP-11: URL pointing to an image to be used as an icon for the relay
        icon = ""

        # List of supported NIPs as JSON array, or empty string to use default
        # Empty = use strfry defaults
        nips = ""
    }

    # Maximum accepted incoming websocket frame size (should be larger than max event) (restart required)
    maxWebsocketPayloadSize = 131072

    # Maximum number of filters allowed in a REQ
    # Dev/E2E: Generous limit for complex queries
    maxReqFilterSize = 200

    # Websocket-level PING message frequency (should be less than any reverse proxy idle timeouts) (restart required)
    # Dev/E2E: 55 seconds (default)
    autoPingSeconds = 55

    # If TCP keep-alive should be enabled (detect dropped connections to upstream reverse proxy)
    enableTcpKeepalive = false

    # How much uninterrupted CPU time a REQ query should get during its DB scan (microseconds)
    queryTimesliceBudgetMicroseconds = 10000

    # Maximum records that can be returned per filter
    # Dev/E2E: Moderate limit suitable for testing
    maxFilterLimit = 500

    # Maximum number of subscriptions (concurrent REQs) a connection can have open at any time
    # Dev/E2E: Generous limit for multi-subscription scenarios
    maxSubsPerConnection = 20

    writePolicy {
        # If non-empty, path to an executable script that implements the writePolicy plugin logic
        # Dev/E2E: No custom write policy
        plugin = ""
    }

    compression {
        # Use permessage-deflate compression if supported by client. Reduces bandwidth, but slight increase in CPU (restart required)
        enabled = true

        # Maintain a sliding window buffer for each connection. Improves compression, but uses more memory (restart required)
        slidingWindow = true
    }

    logging {
        # Dump all incoming messages (useful for debugging)
        dumpInAll = false

        # Dump all incoming EVENT messages
        dumpInEvents = false

        # Dump all incoming REQ/CLOSE messages
        dumpInReqs = false

        # Log performance metrics for initial REQ database scans
        dbScanPerf = false

        # Log reason for invalid event rejection? Can be disabled to silence excessive logging
        # Dev/E2E: Keep enabled to catch validation issues
        invalidEvents = true
    }

    numThreads {
        # Ingester threads: route incoming requests, validate events/sigs (restart required)
        # Dev/E2E: Lower thread count suitable for single-user testing
        ingester = 2

        # reqWorker threads: Handle initial DB scan for events (restart required)
        reqWorker = 2

        # reqMonitor threads: Handle filtering of new events (restart required)
        reqMonitor = 2

        # negentropy threads: Handle negentropy protocol messages (restart required)
        negentropy = 1
    }

    negentropy {
        # Support negentropy protocol messages (efficient set reconciliation)
        enabled = true

        # Maximum records that sync will process before returning an error
        maxSyncEvents = 1000000
    }
}

## Rate Limiting Notes:
##
## Strfry does not have built-in rate limiting in the config file.
## For production deployments, implement rate limiting via:
## - Reverse proxy (nginx, caddy) with rate limiting directives
## - Custom writePolicy plugin for event submission rate limits
## - Connection limits at the OS/firewall level
##
## Dev/E2E: No rate limiting needed for local testing
