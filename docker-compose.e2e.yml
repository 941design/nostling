services:
  nostr-relay:
    image: ghcr.io/dockur/strfry:latest
    container_name: nostling-e2e-relay
    ports:
      - "8080:8080"
    volumes:
      - ./strfry.conf:/etc/strfry.conf:ro
      - strfry-data:/app/strfry-db
    restart: unless-stopped

  e2e-test:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    container_name: nostling-e2e-test
    depends_on:
      - nostr-relay
    volumes:
      # Mount test results and reports for local inspection
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
    environment:
      - CI=true
      - NODE_ENV=test
      - FORCE_COLOR=1
      - NOSTLING_DATA_DIR=/tmp/nostling-e2e-data
      - NOSTLING_DEV_RELAY=ws://nostr-relay:8080
      - NOSTLING_SHOW_MESSAGE_INFO=true
      - NOSTLING_SHOW_WARNING_ICON=true
      - NOSTLING_ENABLE_P2P=true
      - TEST_FILE=${TEST_FILE:-}
    # Allocate sufficient shared memory for Chromium
    shm_size: '2gb'
    # Show output in real-time
    stdin_open: true
    tty: true

volumes:
  strfry-data:
